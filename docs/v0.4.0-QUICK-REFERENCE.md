# v0.4.0 - Quick Reference Guide

> **Philosophy**: Same quality as FastAPI, better DX, incremental progress

**Current Version:** v0.3.13-alpha  
**Target Version:** v0.4.0  
**Status:** Planning â†’ Implementation  

---

## ğŸ¯ The Vision

**Better than FastAPI in:**
- ğŸ† Content Negotiation (they don't have a helper)
- ğŸ† Testing (TinyTest + SmartMutator)
- ğŸ† Dual Runtime (Node.js + Bun)
- ğŸ† Dependency Injection (simpler with `inject()`)

**Equal to FastAPI in:**
- âœ… File uploads/downloads
- âœ… Streaming responses
- âœ… Static files
- âœ… Forms
- âœ… Redirects

---

## ğŸ“‹ Progress Tracker

### âœ… Completed (v0.3.13)
- [x] HEAD method
- [x] OPTIONS method
- [x] Auto-OPTIONS for CORS

### ğŸ”„ In Progress
- [ ] **Phase 0: Foundations (5-6 days)**
  - [ ] Streaming Support (2-3 days) ğŸ”´ START HERE
  - [ ] Multipart Support (2 days)
  - [ ] Form-urlencoded Verification (0.5 days)

### â³ Pending
- [ ] **Phase 1: Quick Wins (3 days)**
  - [ ] Redirect Helper (1 day)
  - [ ] Content Negotiation (2 days)

- [ ] **Phase 2: File Features (7-8 days)**
  - [ ] File Downloads (2 days)
  - [ ] Static Files (2 days)
  - [ ] Form Data Support (2 days)
  - [ ] File Uploads (3 days)

**Total Progress:** 3/9 features (33%)  
**Estimated Time Remaining:** 15-17 days

---

## ğŸ—ï¸ Current Task: Streaming Support

### Why This First?
- Blocks: File downloads, Static files, File uploads
- Risk: OOM crashes with large files if we skip this
- Foundation: Everything else builds on top

### Implementation Checklist

**1. Extend Types (domain/types.ts)**
```typescript
import type { Readable } from 'stream';

export type RouteHandler<...> = (
  context: RequestContext<...>
) => TResponse | Promise<TResponse> | Readable | Buffer;
```

**2. Stream Detection (infrastructure/FastifyAdapter.ts)**
```typescript
// After: const result = await route.handler(context);

// NEW: Detect streams
if (result instanceof Readable) {
  reply.header('Transfer-Encoding', 'chunked');
  return reply.send(result);
}

// NEW: Detect buffers
if (Buffer.isBuffer(result)) {
  reply.header('Content-Length', result.length.toString());
  return reply.send(result);
}
```

**3. Skip Validation for Streams**
```typescript
// Only validate if not stream/buffer
if (route.config.response && 
    !(result instanceof Readable) && 
    !Buffer.isBuffer(result)) {
  SchemaValidator.validateOrThrow(route.config.response, result);
}
```

**4. Tests to Write**
- [ ] Stream small file (<1MB)
- [ ] Stream large file (>100MB) - verify low memory
- [ ] Buffer response
- [ ] Stream error handling (file not found)
- [ ] Concurrent streams (10+ simultaneous)
- [ ] Mixed stream + JSON in same app

**5. MIME Type Helper (optional, nice to have)**
```typescript
// infrastructure/MimeTypeDetector.ts
export function detectMimeType(filename: string): string {
  const ext = path.extname(filename).toLowerCase();
  return mimeTypes[ext] || 'application/octet-stream';
}
```

---

## ğŸ¨ Developer Experience Goals

### FastAPI Way (Python):
```python
from fastapi.responses import StreamingResponse

@app.get("/download")
def download():
    return StreamingResponse(open("file.pdf", "rb"))
```

### Our Way (TypeScript):
```typescript
// Option 1: Automatic (more magical, better DX)
app.get('/download', {
  handler: () => fs.createReadStream('file.pdf')
});

// Option 2: Explicit (more control)
import { stream } from 'syntrojs/helpers';

app.get('/download', {
  handler: () => stream(fs.createReadStream('file.pdf'), {
    contentType: 'application/pdf',
    filename: 'download.pdf'
  })
});
```

**Decision:** Start with Option 1 (automatic), add Option 2 later if needed.

---

## ğŸ§ª Testing Pattern

```typescript
// tests/features/streaming.test.ts

import { TinyTest } from 'syntrojs/testing';
import { createReadStream } from 'fs';

test('should stream large file without OOM', async () => {
  const api = new TinyTest();
  
  api.get('/large-file', {
    handler: () => createReadStream('test-fixtures/100mb.bin')
  });
  
  const response = await api.request('GET', '/large-file');
  
  expect(response.status).toBe(200);
  expect(response.headers.get('transfer-encoding')).toBe('chunked');
  // Verify memory usage stayed low during stream
});
```

---

## ğŸ“¦ Dependencies Status

```json
{
  "dependencies": {
    "@fastify/static": "^7.0.0",        // âœ… Installed
    "@fastify/multipart": "^8.0.0",     // âŒ Need to add
    "fastify": "^4.26.0",               // âœ… Has stream support
    "zod": "^3.22.4"                    // âœ… Installed
  },
  "optionalDependencies": {
    "@fastify/formbody": "^8.0.0"       // âš ï¸ Test if needed
  }
}
```

---

## ğŸš€ Daily Workflow

### 1. Morning: Review
- Read quick reference (this file)
- Check TODO list
- Review detailed roadmap (v0.4.0-FOUNDATIONS-ROADMAP.md)

### 2. During Development
- Update TODO status (pending â†’ in_progress â†’ completed)
- Write tests FIRST (TDD approach)
- Commit incrementally
- Update progress in this file

### 3. End of Day
- Mark completed tasks
- Document blockers/decisions
- Plan next day

---

## ğŸ¯ Success Criteria

### Phase 0 Done When:
- âœ… Can stream 100MB+ files without OOM
- âœ… Buffer responses work
- âœ… Multipart file uploads work
- âœ… Form-urlencoded parsing works
- âœ… All foundation tests pass (30+ tests)
- âœ… Released as v0.4.0-alpha.1

### v0.4.0 Done When:
- âœ… All 9 features implemented
- âœ… 100+ new tests passing
- âœ… Documentation updated
- âœ… Examples for each feature
- âœ… No breaking changes from v0.3.x
- âœ… Performance maintained

---

## ğŸ’¡ Key Principles

1. **Quality over Speed** - Do it right, even if it takes longer
2. **Incremental Progress** - Release alphas, get feedback
3. **Better DX** - Abstract complexity, make it trivial
4. **Test Everything** - TDD approach, mutation testing
5. **Learn from FastAPI** - They solved these problems well
6. **Innovate Where Possible** - Content negotiation, testing

---

## ğŸ“š Related Documents

- **Detailed Roadmap:** `v0.4.0-FOUNDATIONS-ROADMAP.md` (full technical analysis)
- **Main Roadmap:** `ROADMAP.md` (project overview)
- **Architecture:** `ARCHITECTURE.md` (design principles)
- **Testing:** `TESTING_STRATEGY.md` (testing approach)

---

## ğŸ”¥ Motivation

> "FastAPI took years to get where it is. We're building something better, step by step. Every foundation we lay correctly saves us from painful refactors later."

**Remember:** We're not just copying FastAPI. We're creating the best TypeScript API framework with:
- Better testing story
- Dual runtime support
- Cleaner dependency injection
- More elegant content negotiation

**This matters.** Take your time. Do it right. ğŸš€

---

**Last Updated:** 2025-11-03  
**Next Task:** Streaming Support (start Phase 0)  
**Current Branch:** `feature/v0.4.0-foundations` (to be created)

