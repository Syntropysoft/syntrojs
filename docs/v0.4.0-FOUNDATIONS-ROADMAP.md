# v0.4.0 - Foundations & REST Completion Roadmap

> **Strategic Analysis**: Foundation requirements for REST API completion features

**Created:** 2025-11-03  
**Status:** Planning Phase  
**Target Version:** v0.4.0  

---

## üìã Executive Summary

This document provides a comprehensive analysis of the architectural foundations required to implement v0.4.0 features safely, without requiring major refactoring later.

**Current Status:** v0.3.13-alpha
- ‚úÖ 3/9 features completed (HEAD, OPTIONS, Auto-OPTIONS)
- üî¥ 6/9 features pending
- ‚ö†Ô∏è **Critical foundations missing**

**Key Finding:** Implementing file-related features without proper streaming and multipart support will lead to:
1. Memory issues with large files (OOM crashes)
2. Incomplete implementations requiring full rewrites
3. Architectural debt

---

## üéØ v0.4.0 Feature List

### ‚úÖ Completed (v0.3.13)
1. HEAD method - ‚úÖ Done
2. OPTIONS method - ‚úÖ Done
3. Auto-OPTIONS for CORS - ‚úÖ Done

### üî¥ Pending
4. **File downloads helper** - 2 days (depends on streaming)
5. **Static file serving** - 2 days (depends on streaming + @fastify/static integration)
6. **Redirect helper** - 1 day (independent, quick win)
7. **File uploads** - 3 days (depends on multipart + streaming)
8. **Form data support** - 2 days (depends on form-urlencoded parsing)
9. **Content negotiation** - 2 days (independent)

**Original Estimate:** ~11 days  
**With Foundations:** ~16-17 days  

---

## üèóÔ∏è Foundation Requirements Analysis

### ‚úÖ Already Implemented

#### 1. Custom Response Headers
**Status:** ‚úÖ FULLY IMPLEMENTED  
**Location:** `FastifyAdapter.ts` lines 150-172

```typescript
// Handlers can return full response control
app.get('/example', {
  handler: () => ({
    status: 200,
    body: { data: 'value' },
    headers: { 'Content-Type': 'application/json', 'X-Custom': 'value' }
  })
});
```

**Evidence:** Already used in docs rendering, OpenAPI endpoints.

#### 2. Custom Status Codes
**Status:** ‚úÖ FULLY IMPLEMENTED  
**Location:** `RouteConfig.status` + response object

```typescript
// Via config
app.post('/users', {
  status: 201,
  handler: () => user
});

// Via response object
app.get('/redirect', {
  handler: () => ({ status: 301, body: '', headers: { Location: '/new' } })
});
```

#### 3. JSON/HTML/String Responses
**Status:** ‚úÖ FULLY IMPLEMENTED  
**Location:** `FastifyAdapter.ts` lines 174-176

Fastify automatically serializes:
- Objects ‚Üí JSON
- Strings ‚Üí text/html or text/plain (based on Content-Type)

#### 4. Zod Validation
**Status:** ‚úÖ FULLY IMPLEMENTED  
**Location:** `SchemaValidator.ts`, `FastifyAdapter.ts` lines 121-133

Validates: params, query, body, response

#### 5. @fastify/static Package
**Status:** ‚úÖ INSTALLED (v7.0.0)  
**Location:** `package.json` line 80  
**Integration Status:** ‚ùå NOT INTEGRATED into framework

---

### üî¥ Missing Critical Foundations

#### 1. STREAMING SUPPORT

**Status:** ‚ùå NOT IMPLEMENTED  
**Priority:** üî¥ CRITICAL - Blocks 4 features  
**Estimated Effort:** 2-3 days  

**Impacts:**
- File downloads (blocked)
- Static file serving (blocked)
- File uploads (blocked)
- Large responses (blocked)

**Current Problem:**
```typescript
// ‚ùå THIS DOES NOT WORK
app.get('/download', {
  handler: () => {
    return fs.createReadStream('large-file.pdf'); // Returns Stream - not handled
  }
});

// ‚ùå THIS DOES NOT WORK
app.get('/image', {
  handler: () => {
    return Buffer.from(imageData); // Returns Buffer - not handled
  }
});
```

**What Happens Now:**
- Fastify tries to serialize Stream/Buffer as JSON ‚Üí üí• Crash or corrupted response
- Response validation fails on non-JSON types
- No automatic headers (Content-Length, Transfer-Encoding)

**Required Changes:**

1. **Extend RouteHandler return type:**
```typescript
// domain/types.ts
import type { Readable } from 'stream';

export type RouteHandler<...> = (
  context: RequestContext<...>
) => TResponse | Promise<TResponse> | Readable | Buffer;
```

2. **Stream detection in FastifyAdapter:**
```typescript
// infrastructure/FastifyAdapter.ts (line ~136)

// After handler execution, before response validation
const result = await route.handler(context);

// NEW: Detect streams
if (result instanceof Readable) {
  // Set appropriate headers
  reply.header('Transfer-Encoding', 'chunked');
  // Skip response validation for streams
  return reply.send(result);
}

// NEW: Detect buffers
if (Buffer.isBuffer(result)) {
  reply.header('Content-Length', result.length.toString());
  // Skip response validation for buffers
  return reply.send(result);
}

// Validate response if schema exists (existing code)
if (route.config.response) {
  SchemaValidator.validateOrThrow(route.config.response, result);
}
```

3. **Automatic Content-Type detection:**
```typescript
// Helper function
function detectContentType(filename: string): string {
  const ext = path.extname(filename).toLowerCase();
  const mimeTypes: Record<string, string> = {
    '.pdf': 'application/pdf',
    '.jpg': 'image/jpeg',
    '.png': 'image/png',
    '.mp4': 'video/mp4',
    '.zip': 'application/zip',
    // ... more
  };
  return mimeTypes[ext] || 'application/octet-stream';
}
```

4. **Tests required:**
   - Stream small file (< 1MB)
   - Stream large file (> 100MB) - verify no OOM
   - Stream with error handling (file not found)
   - Buffer response
   - Concurrent stream requests

**Dependencies:**
- Node.js `stream` module (built-in)
- No new packages required

---

#### 2. MULTIPART FORM DATA SUPPORT

**Status:** ‚ùå NOT INSTALLED, NOT INTEGRATED  
**Priority:** üî¥ CRITICAL - Blocks file uploads  
**Estimated Effort:** 2 days  

**Impacts:**
- File uploads (completely blocked)
- Form data with files (completely blocked)

**Current Problem:**
```typescript
// ‚ùå THIS DOES NOT WORK
app.post('/upload', {
  handler: async (context) => {
    // context.files does not exist
    // context.body only has JSON, not files
    return { uploaded: context.files[0].filename }; // ‚ùå undefined
  }
});
```

**What Happens Now:**
- Multipart requests are not parsed
- Files are silently ignored
- Body parsing fails

**Required Changes:**

1. **Add dependency:**
```json
// package.json
"dependencies": {
  "@fastify/multipart": "^8.0.0"  // ADD THIS
}
```

2. **Register plugin in FastifyAdapter:**
```typescript
// infrastructure/FastifyAdapter.ts

import multipart from '@fastify/multipart';

create(config: FastifyAdapterConfig = {}): FastifyInstance {
  const instance = Fastify({...});
  
  // NEW: Register multipart
  instance.register(multipart, {
    limits: {
      fileSize: 50 * 1024 * 1024, // 50MB default
      files: 10 // Max 10 files per request
    }
  });
  
  return instance;
}
```

3. **Extend RequestContext:**
```typescript
// domain/types.ts

export interface UploadedFile {
  /** Original filename */
  filename: string;
  /** MIME type */
  mimetype: string;
  /** Encoding */
  encoding: string;
  /** File size in bytes */
  size: number;
  /** Readable stream of file data */
  stream: Readable;
  /** Save file to disk */
  save(path: string): Promise<void>;
}

export interface RequestContext<...> {
  // ... existing fields ...
  
  /** Uploaded files (multipart/form-data) */
  files?: UploadedFile[];
  
  /** Form fields (multipart/form-data) */
  fields?: Record<string, string>;
}
```

4. **Parse files in FastifyAdapter:**
```typescript
// infrastructure/FastifyAdapter.ts (in registerRoute)

registerRoute(fastify: FastifyInstance, route: Route): void {
  fastify[method](route.path, async (request: FastifyRequest, reply: FastifyReply) => {
    // ... build context ...
    
    // NEW: Parse multipart if present
    if (request.isMultipart()) {
      const parts = request.parts();
      const files: UploadedFile[] = [];
      const fields: Record<string, string> = {};
      
      for await (const part of parts) {
        if (part.type === 'file') {
          files.push({
            filename: part.filename,
            mimetype: part.mimetype,
            encoding: part.encoding,
            size: 0, // Will be calculated during save
            stream: part.file,
            save: async (path: string) => {
              const writeStream = fs.createWriteStream(path);
              await pipeline(part.file, writeStream);
            }
          });
        } else {
          fields[part.fieldname] = part.value as string;
        }
      }
      
      context.files = files;
      context.fields = fields;
    }
    
    // ... rest of handler ...
  });
}
```

5. **Create file validation schema:**
```typescript
// application/FileValidator.ts (NEW FILE)

export interface FileConstraints {
  maxSize?: number; // bytes
  allowedTypes?: string[]; // MIME types
  required?: boolean;
}

export class FileValidator {
  static validate(file: UploadedFile, constraints: FileConstraints): void {
    // Guard: required
    if (constraints.required && !file) {
      throw new ValidationException('File is required');
    }
    
    // Guard: max size
    if (constraints.maxSize && file.size > constraints.maxSize) {
      throw new ValidationException(
        `File too large: ${file.size} bytes (max ${constraints.maxSize})`
      );
    }
    
    // Guard: allowed types
    if (constraints.allowedTypes && !constraints.allowedTypes.includes(file.mimetype)) {
      throw new ValidationException(
        `Invalid file type: ${file.mimetype} (allowed: ${constraints.allowedTypes.join(', ')})`
      );
    }
  }
}
```

6. **Tests required:**
   - Upload single file
   - Upload multiple files
   - Upload with form fields
   - File size validation
   - MIME type validation
   - Large file upload (>50MB)
   - Concurrent uploads

**Dependencies:**
- `@fastify/multipart` ^8.0.0 (needs to be added)

---

#### 3. FORM-URLENCODED PARSING

**Status:** ‚ö†Ô∏è PROBABLY WORKS (Fastify default)  
**Priority:** üü° MEDIUM - Needs verification  
**Estimated Effort:** 0.5 days (if works) or 1 day (if needs plugin)  

**Impacts:**
- Form data support feature

**Current Status - Needs Testing:**
```typescript
// Does this work? (probably yes with Fastify 4.26)
app.post('/form', {
  body: z.object({
    name: z.string(),
    email: z.string().email()
  }),
  handler: ({ body }) => body
});

// With request:
// Content-Type: application/x-www-form-urlencoded
// Body: name=John&email=john@example.com
```

**Required Actions:**

1. **Test current behavior:**
```typescript
// test/infrastructure/form-parsing.test.ts (NEW FILE)

test('should parse form-urlencoded data', async () => {
  const api = new TinyTest();
  
  api.post('/form', {
    body: z.object({ name: z.string(), age: z.number() }),
    handler: ({ body }) => body
  });
  
  const response = await api.request('POST', '/form', {
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: 'name=John&age=30'
  });
  
  expect(response.status).toBe(200);
  expect(response.data).toEqual({ name: 'John', age: 30 });
});
```

2. **If it doesn't work, add plugin:**
```typescript
// infrastructure/FastifyAdapter.ts

import formBody from '@fastify/formbody';

create(config: FastifyAdapterConfig = {}): FastifyInstance {
  const instance = Fastify({...});
  
  // Register form body parser
  instance.register(formBody);
  
  return instance;
}
```

**Dependencies:**
- Possibly `@fastify/formbody` (if Fastify doesn't include it by default)

---

#### 4. CONTENT NEGOTIATION

**Status:** ‚ùå NOT IMPLEMENTED  
**Priority:** üü° MEDIUM - Independent feature  
**Estimated Effort:** 2 days  

**Impacts:**
- Content negotiation feature (v0.4.0 goal)

**Current Problem:**
```typescript
// ‚ùå Manual content negotiation is verbose
app.get('/users', {
  handler: ({ headers }) => {
    const accept = headers.accept || 'application/json';
    
    if (accept.includes('application/xml')) {
      return {
        status: 200,
        body: toXML(users),
        headers: { 'Content-Type': 'application/xml' }
      };
    }
    
    if (accept.includes('text/csv')) {
      return {
        status: 200,
        body: toCSV(users),
        headers: { 'Content-Type': 'text/csv' }
      };
    }
    
    return users; // Default JSON
  }
});
```

**Desired API:**
```typescript
// ‚úÖ Clean, declarative
app.get('/users', {
  handler: ({ negotiate }) => {
    return negotiate({
      'application/json': () => users,
      'application/xml': () => toXML(users),
      'text/csv': () => toCSV(users)
    });
  }
});
```

**Required Changes:**

1. **Create ContentNegotiator service:**
```typescript
// application/ContentNegotiator.ts (NEW FILE)

export interface ContentOptions {
  [mimeType: string]: () => unknown | Promise<unknown>;
}

export class ContentNegotiator {
  /**
   * Negotiate content type based on Accept header
   */
  static negotiate(
    acceptHeader: string,
    options: ContentOptions
  ): { contentType: string; body: unknown } {
    // Guard: no accept header
    if (!acceptHeader || acceptHeader === '*/*') {
      // Use first option as default
      const [defaultType, defaultFn] = Object.entries(options)[0];
      return { contentType: defaultType, body: defaultFn() };
    }
    
    // Parse accept header (handle quality values)
    const accepted = this.parseAcceptHeader(acceptHeader);
    
    // Find first match
    for (const acceptedType of accepted) {
      for (const [optionType, fn] of Object.entries(options)) {
        if (this.matches(acceptedType, optionType)) {
          return { contentType: optionType, body: fn() };
        }
      }
    }
    
    // No match - throw 406 Not Acceptable
    throw new HTTPException(406, 'Not Acceptable', {
      acceptable: Object.keys(options),
      requested: acceptHeader
    });
  }
  
  /**
   * Parse Accept header with quality values
   * Example: "application/json;q=0.9, text/xml;q=0.8"
   */
  private static parseAcceptHeader(accept: string): string[] {
    return accept
      .split(',')
      .map(part => {
        const [type, ...params] = part.trim().split(';');
        const quality = params
          .find(p => p.trim().startsWith('q='))
          ?.split('=')[1];
        return { type: type.trim(), q: parseFloat(quality || '1.0') };
      })
      .sort((a, b) => b.q - a.q) // Sort by quality (highest first)
      .map(item => item.type);
  }
  
  /**
   * Check if MIME types match (supports wildcards)
   */
  private static matches(pattern: string, type: string): boolean {
    if (pattern === '*/*') return true;
    if (pattern === type) return true;
    
    const [patternMain, patternSub] = pattern.split('/');
    const [typeMain, typeSub] = type.split('/');
    
    if (patternMain === '*') return true;
    if (patternMain !== typeMain) return false;
    if (patternSub === '*') return true;
    
    return patternSub === typeSub;
  }
}
```

2. **Extend RequestContext:**
```typescript
// domain/types.ts

export interface RequestContext<...> {
  // ... existing fields ...
  
  /** Content negotiation helper */
  negotiate: (options: ContentOptions) => { contentType: string; body: unknown };
}
```

3. **Integrate in FastifyAdapter:**
```typescript
// infrastructure/FastifyAdapter.ts (buildContext)

private buildContext(request: FastifyRequest): RequestContext {
  return {
    // ... existing fields ...
    
    negotiate: (options) => ContentNegotiator.negotiate(
      request.headers.accept || '*/*',
      options
    )
  };
}
```

4. **Handle negotiated response:**
```typescript
// infrastructure/FastifyAdapter.ts (registerRoute, after handler)

const result = await route.handler(context);

// Check if result is negotiated content
if (result && typeof result === 'object' && 'contentType' in result && 'body' in result) {
  reply.header('Content-Type', result.contentType);
  return reply.send(result.body);
}
```

5. **Tests required:**
   - Negotiate with single Accept type
   - Negotiate with multiple types (quality values)
   - Negotiate with wildcards (`*/*`, `text/*`)
   - Return 406 when no match
   - Default to first option when no Accept header

**Dependencies:**
- None (pure TypeScript)

---

#### 5. REDIRECT HELPER

**Status:** ‚ùå NOT IMPLEMENTED (but easy)  
**Priority:** üü¢ LOW - Quick win, independent  
**Estimated Effort:** 1 day  

**Impacts:**
- Redirect feature (v0.4.0 goal)
- Developer experience

**Current Workaround (works but verbose):**
```typescript
// ‚úÖ This works now, but verbose
app.get('/old-path', {
  handler: () => ({
    status: 301,
    body: '',
    headers: { Location: '/new-path' }
  })
});
```

**Desired API:**
```typescript
// ‚úÖ Clean, expressive
app.get('/old-path', {
  handler: ({ redirect }) => redirect('/new-path', 301)
});

// Or with helper
import { redirect } from 'syntrojs/helpers';

app.get('/old-path', {
  handler: () => redirect('/new-path') // Defaults to 302
});
```

**Required Changes:**

1. **Create Response helpers:**
```typescript
// domain/helpers.ts (NEW FILE)

export interface RedirectOptions {
  permanent?: boolean; // 301 vs 302
  preserve?: boolean;  // 307 vs 308 (preserve method)
}

/**
 * Create redirect response
 */
export function redirect(
  url: string,
  codeOrOptions?: number | RedirectOptions
): RouteResponse<string> {
  // Parse options
  let code = 302; // Default: temporary redirect
  
  if (typeof codeOrOptions === 'number') {
    code = codeOrOptions;
  } else if (codeOrOptions) {
    if (codeOrOptions.preserve) {
      code = codeOrOptions.permanent ? 308 : 307;
    } else {
      code = codeOrOptions.permanent ? 301 : 302;
    }
  }
  
  // Validate redirect code
  if (![301, 302, 303, 307, 308].includes(code)) {
    throw new Error(`Invalid redirect code: ${code}`);
  }
  
  return {
    status: code,
    body: '',
    headers: { Location: url }
  };
}
```

2. **Add to context (optional, for consistency):**
```typescript
// domain/types.ts

export interface RequestContext<...> {
  // ... existing fields ...
  
  /** Redirect helper */
  redirect: (url: string, codeOrOptions?: number | RedirectOptions) => RouteResponse<string>;
}
```

3. **Export helper:**
```typescript
// src/index.ts

export { redirect } from './domain/helpers';
```

4. **Tests required:**
   - Redirect 301 (permanent)
   - Redirect 302 (temporary, default)
   - Redirect 307 (preserve method)
   - Redirect 308 (permanent, preserve method)
   - Redirect with relative URL
   - Redirect with absolute URL
   - Invalid redirect code throws error

**Dependencies:**
- None

---

## üìÖ Implementation Roadmap

### Strategy A: Foundations First (Recommended)

**Total Time:** 16-17 days

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Phase 0: Critical Foundations (5-6 days)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
v0.4.0-alpha.1 (Foundations Release)
  Day 1-3:  Streaming Support üî¥
            ‚îú‚îÄ Stream detection & handling
            ‚îú‚îÄ Buffer support
            ‚îú‚îÄ Automatic headers
            ‚îî‚îÄ Tests (small files, large files, errors)
  
  Day 4-5:  Multipart Support üî¥
            ‚îú‚îÄ Add @fastify/multipart dependency
            ‚îú‚îÄ Integrate plugin in FastifyAdapter
            ‚îú‚îÄ Extend RequestContext (files, fields)
            ‚îú‚îÄ FileValidator service
            ‚îî‚îÄ Tests (single file, multiple, validation)
  
  Day 6:    Form-urlencoded Verification üü°
            ‚îú‚îÄ Test current Fastify behavior
            ‚îî‚îÄ Add plugin if needed

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Phase 1: Quick Wins (3 days)                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
v0.4.1 ‚Üí Redirect Helper (1 day) üü¢
         ‚îú‚îÄ Response helpers
         ‚îú‚îÄ Context integration
         ‚îî‚îÄ Tests

v0.4.2 ‚Üí Content Negotiation (2 days) üü°
         ‚îú‚îÄ ContentNegotiator service
         ‚îú‚îÄ Accept header parsing
         ‚îú‚îÄ Context integration
         ‚îî‚îÄ Tests

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Phase 2: File Features (7-8 days)                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
v0.4.3 ‚Üí File Downloads Helper (2 days)
         ‚îú‚îÄ Content-Disposition headers
         ‚îú‚îÄ MIME type detection
         ‚îú‚îÄ Stream-based downloads
         ‚îî‚îÄ Tests (various file types)

v0.4.4 ‚Üí Static File Serving (2 days)
         ‚îú‚îÄ Integrate @fastify/static
         ‚îú‚îÄ Configuration API
         ‚îú‚îÄ SPA support (fallback)
         ‚îî‚îÄ Tests

v0.4.5 ‚Üí Form Data Support (2 days)
         ‚îú‚îÄ Form-urlencoded parsing (if needed)
         ‚îú‚îÄ Zod integration
         ‚îî‚îÄ Tests

v0.4.6 ‚Üí File Uploads (3 days)
         ‚îú‚îÄ Multipart route config
         ‚îú‚îÄ File constraints (size, type)
         ‚îú‚îÄ Multiple file uploads
         ‚îú‚îÄ Save to disk/storage
         ‚îî‚îÄ Tests (edge cases, security)
```

**Milestones:**
- End of Phase 0: All foundations in place, no blocking issues
- End of Phase 1: 5/9 features complete (56%)
- End of Phase 2: 9/9 features complete (100%) ‚úÖ

---

### Strategy B: Quick Wins First (Alternative)

**Total Time:** 16-17 days (same, but different order)

```
Week 1:
  Day 1:   Redirect Helper üü¢
  Day 2-3: Content Negotiation üü°
  Day 4:   Form-urlencoded Testing üü°
  Day 5:   Form Data Support (if form-urlencoded works)
  
  Progress: 3/9 features (33%) - but file features still blocked

Week 2:
  Day 1-3: Streaming Support üî¥ (critical bottleneck)
  Day 4-5: Multipart Support üî¥ (critical bottleneck)

Week 3:
  Day 1-2: File Downloads 
  Day 3-4: Static Files
  Day 5-7: File Uploads
  
  Progress: 9/9 features (100%) ‚úÖ
```

**Pros:** 
- Early wins boost morale
- Can release 3 features in first week

**Cons:**
- Week 2 is all infrastructure (no visible progress)
- File features concentrated at end (risky)

---

## üéØ Recommended Strategy

**Go with Strategy A: Foundations First**

**Reasoning:**
1. **Risk Mitigation:** File features are high-risk. Building foundations first reduces technical debt.
2. **Logical Dependencies:** Can't implement file features without foundations anyway.
3. **Better Testing:** Test foundations thoroughly before building on top.
4. **Psychological:** Having solid foundations makes Phase 2 faster and less stressful.
5. **Version Strategy:** Can release v0.4.0-alpha.1 with just foundations for early feedback.

---

## üìä Dependency Graph

```
Foundations Layer:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Streaming       ‚îÇ‚îÄ‚îÄ‚îê
‚îÇ Support         ‚îÇ  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
                     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ Multipart       ‚îÇ  ‚îÇ
‚îÇ Support         ‚îÇ  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
                     ‚îú‚îÄ‚îÄ> File Downloads
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ Form-urlencoded ‚îÇ  ‚îÇ
‚îÇ Parsing         ‚îÇ  ‚îú‚îÄ‚îÄ> Static Files
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
                     ‚îî‚îÄ‚îÄ> File Uploads

Independent Features:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Redirect Helper ‚îÇ (no dependencies)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Content         ‚îÇ (no dependencies)
‚îÇ Negotiation     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Form Data       ‚îÇ (depends on form-urlencoded only)
‚îÇ Support         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚ö†Ô∏è Risk Assessment

### High Risk (if foundations skipped)

1. **Memory Issues**
   - **Scenario:** Implement file downloads without streaming
   - **Impact:** OOM crashes with files >100MB
   - **Probability:** 100%
   - **Mitigation:** Implement streaming first

2. **Incomplete Implementations**
   - **Scenario:** Implement file uploads without multipart
   - **Impact:** Feature doesn't work at all, requires rewrite
   - **Probability:** 100%
   - **Mitigation:** Add @fastify/multipart first

3. **Security Vulnerabilities**
   - **Scenario:** File uploads without validation
   - **Impact:** Arbitrary file upload, DoS via large files
   - **Probability:** High
   - **Mitigation:** Implement FileValidator service

### Medium Risk

4. **Form Parsing Issues**
   - **Scenario:** Fastify doesn't parse form-urlencoded by default
   - **Impact:** 0.5-1 day delay to add plugin
   - **Probability:** 30%
   - **Mitigation:** Test early in Phase 0

5. **Content Negotiation Edge Cases**
   - **Scenario:** Complex Accept headers break parsing
   - **Impact:** 406 errors for valid requests
   - **Probability:** 40%
   - **Mitigation:** Comprehensive test suite

### Low Risk

6. **Redirect Helper**
   - **Scenario:** Minimal implementation, well-understood
   - **Impact:** None
   - **Probability:** <5%

---

## üß™ Testing Strategy

### Foundations Testing (Must Pass Before Phase 1)

**Streaming:**
- [ ] Small file stream (<1MB)
- [ ] Large file stream (>100MB) - verify memory usage stays low
- [ ] Concurrent streams (10+ simultaneous)
- [ ] Stream error handling (file not found, permission denied)
- [ ] Buffer response
- [ ] Mixed stream + JSON responses in same app

**Multipart:**
- [ ] Single file upload
- [ ] Multiple files (5+ files)
- [ ] File + form fields
- [ ] File size validation (reject >50MB)
- [ ] MIME type validation (allow only images)
- [ ] Concurrent uploads
- [ ] Large file upload (>100MB)
- [ ] Empty file handling

**Form-urlencoded:**
- [ ] Simple form (name=value)
- [ ] Nested objects (user[name]=John)
- [ ] Arrays (tags[]=a&tags[]=b)
- [ ] Special characters (name=John%20Doe)
- [ ] Zod validation integration

### Feature Testing

**File Downloads:**
- [ ] Download with correct Content-Disposition
- [ ] Download with automatic MIME type
- [ ] Download with custom filename
- [ ] Download non-ASCII filename (UTF-8)
- [ ] Inline vs attachment

**Static Files:**
- [ ] Serve file from directory
- [ ] Serve index.html by default
- [ ] 404 for missing files
- [ ] ETag support
- [ ] Cache headers
- [ ] SPA fallback

**File Uploads:**
- [ ] Upload to local disk
- [ ] Upload to memory
- [ ] Upload with progress (streaming)
- [ ] Multiple uploads in parallel
- [ ] Validation errors (size, type)
- [ ] Security: path traversal prevention

**Redirect:**
- [ ] All redirect codes (301, 302, 307, 308)
- [ ] Relative URLs
- [ ] Absolute URLs
- [ ] Query string preservation

**Content Negotiation:**
- [ ] JSON (default)
- [ ] XML
- [ ] CSV
- [ ] 406 when no match
- [ ] Wildcard matching

---

## üì¶ Package Changes Required

### package.json Updates

```json
{
  "dependencies": {
    "@fastify/static": "^7.0.0",  // ‚úÖ Already present
    "@fastify/multipart": "^8.0.0",  // üÜï ADD THIS
    "@syntrojs/logger": "^0.2.1-alpha",
    "fastify": "^4.26.0",
    "zod": "^3.22.4",
    "zod-to-json-schema": "^3.22.4"
  },
  "optionalDependencies": {
    "@fastify/formbody": "^8.0.0",  // üÜï ADD IF NEEDED (test first)
    "redoc": "^2.5.2"
  }
}
```

---

## üöÄ Success Criteria

### Phase 0 Complete When:
- ‚úÖ Stream responses work with 100MB+ files
- ‚úÖ Buffer responses work correctly
- ‚úÖ Multipart parsing extracts files correctly
- ‚úÖ File validation prevents oversized uploads
- ‚úÖ Form-urlencoded parsing works (native or plugin)
- ‚úÖ All foundation tests pass (30+ tests)
- ‚úÖ No memory leaks under load

### v0.4.0 Complete When:
- ‚úÖ All 9 features implemented
- ‚úÖ All tests pass (100+ new tests)
- ‚úÖ Documentation updated
- ‚úÖ Examples for each feature
- ‚úÖ OpenAPI specs include new features
- ‚úÖ No breaking changes from v0.3.x
- ‚úÖ Performance benchmarks maintained

---

## üìù Documentation Requirements

### New Documentation Files Needed:

1. **FILE_HANDLING.md**
   - Streaming responses guide
   - File upload guide
   - File download guide
   - Static files configuration
   - Security best practices

2. **CONTENT_NEGOTIATION.md**
   - Accept header handling
   - Custom content types
   - XML/CSV examples
   - Error handling (406)

3. **FORMS.md**
   - Form-urlencoded parsing
   - Multipart forms
   - File uploads with forms
   - Validation patterns

### Updates to Existing Docs:

- **README.md**: Add new features to feature list
- **ROADMAP.md**: Update progress
- **API.md**: Document new helpers (redirect, negotiate, files)
- **TESTING_STRATEGY.md**: Add file handling test patterns

---

## üéì Learning Resources

### Fastify Documentation:
- [Fastify Multipart](https://github.com/fastify/fastify-multipart)
- [Fastify Static](https://github.com/fastify/fastify-static)
- [Fastify Formbody](https://github.com/fastify/fastify-formbody)
- [Fastify Streaming](https://www.fastify.io/docs/latest/Reference/Reply/#stream)

### Node.js Streams:
- [Stream API Documentation](https://nodejs.org/api/stream.html)
- [Stream Handbook](https://github.com/substack/stream-handbook)

### HTTP Standards:
- [RFC 2616 - HTTP/1.1](https://tools.ietf.org/html/rfc2616)
- [RFC 7231 - Semantics and Content](https://tools.ietf.org/html/rfc7231)
- [RFC 7578 - Multipart Form Data](https://tools.ietf.org/html/rfc7578)
- [MDN - Content Negotiation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Content_negotiation)

---

## üîÑ Version Release Strategy

### Alpha Releases (Testing)

```
v0.4.0-alpha.1 - Foundations Only
  ‚îú‚îÄ Streaming support
  ‚îú‚îÄ Multipart support
  ‚îî‚îÄ Form-urlencoded verification

v0.4.0-alpha.2 - Quick Wins
  ‚îú‚îÄ Redirect helper
  ‚îî‚îÄ Content negotiation

v0.4.0-alpha.3 - File Features Part 1
  ‚îú‚îÄ File downloads
  ‚îî‚îÄ Static files

v0.4.0-alpha.4 - File Features Part 2
  ‚îú‚îÄ Form data
  ‚îî‚îÄ File uploads
```

### Beta Release (Stabilization)

```
v0.4.0-beta.1 - Complete Feature Set
  ‚îú‚îÄ All 9 features
  ‚îú‚îÄ Bug fixes
  ‚îú‚îÄ Performance testing
  ‚îî‚îÄ Documentation complete
```

### Stable Release

```
v0.4.0 - REST Completion
  ‚îú‚îÄ Production ready
  ‚îú‚îÄ All tests passing
  ‚îú‚îÄ Security audit complete
  ‚îî‚îÄ Migration guide from v0.3.x
```

---

## üéØ Next Steps

1. **Decision:** Choose Strategy A or B (recommendation: A)
2. **Setup:** Create feature branch `feature/v0.4.0-foundations`
3. **Phase 0:** Start with streaming support (highest priority)
4. **Incremental:** Release alpha versions for community feedback
5. **Documentation:** Update this roadmap as we progress

---

## üìû Questions & Discussions

**Q: Can we skip streaming and just load files to memory?**  
**A:** No. This will cause OOM crashes with large files (>100MB). Streaming is non-negotiable.

**Q: Can we use a different multipart library?**  
**A:** Not recommended. `@fastify/multipart` is the official Fastify plugin and integrates seamlessly.

**Q: Why not implement quick wins first?**  
**A:** Quick wins don't unblock file features. We'd spend week 2 doing infrastructure anyway. Better to do it upfront.

**Q: What about Bun compatibility?**  
**A:** Streaming and multipart work in Bun. Fastify plugins also work in Bun (via polyfills).

**Q: Should we add XML/CSV parsers for content negotiation?**  
**A:** No. Users provide their own serialization functions. We just handle Accept header logic.

---

**Last Updated:** 2025-11-03  
**Status:** Ready for Implementation  
**Next Review:** After Phase 0 completion

